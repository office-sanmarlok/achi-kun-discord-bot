# スレッド専用セッション機能 実装計画

## 実装タスク一覧

- [ ] 1. 設定管理の基盤実装
  - settings.py を更新して thread_sessions と registered_channels のデータ構造を追加
  - is_channel_registered(), thread_to_session(), add_thread_session() メソッドを実装
  - 既存の channel_sessions 関連コードを削除
  - 単体テストを作成して設定の読み書きを検証
  - _要件: 3.1, 3.4_

- [ ] 2. Discord Bot の Intents 設定更新
  - discord_bot.py の __init__ メソッドで intents.guilds = True を追加
  - on_ready メソッドでギルド関連イベントの受信確認ログを追加
  - _要件: 3.1, 5.1_

- [ ] 3. スレッド作成検出機能の実装
  - [ ] 3.1 on_thread_create イベントハンドラーの基本実装
    - discord_bot.py に on_thread_create メソッドを追加
    - 親チャンネルIDの取得と registered_channels での確認処理を実装
    - 未登録チャンネルの場合はログ出力して処理をスキップ
    - _要件: 3.1_
  
  - [ ] 3.2 スレッド自動参加機能の実装
    - thread.join() を呼び出してBotをスレッドに参加させる
    - 参加成功・失敗のログ出力を追加
    - エラーハンドリングで参加失敗時も処理を継続
    - _要件: 3.1_

- [ ] 4. 親メッセージ取得と初期コンテクスト設定機能の実装
  - [ ] 4.1 親メッセージ取得処理の実装
    - thread.parent.fetch_message(thread.id) で親メッセージを取得
    - 取得したメッセージから作成者名、内容、タイムスタンプを抽出
    - 取得失敗時のエラーハンドリングとログ出力
    - _要件: 3.2_
  
  - [ ] 4.2 初期コンテクスト付きセッション起動機能の実装
    - _start_claude_session_with_context() メソッドを作成
    - tmux new-session でClaude Codeセッションを起動
    - 親メッセージ情報をフォーマットして初期メッセージとして送信
    - asyncio.sleep で適切な待機時間を設定
    - _要件: 3.2, 3.4_

- [ ] 5. スレッドメッセージ処理機能の実装
  - [ ] 5.1 on_message イベントハンドラーの修正
    - チャンネルタイプが public_thread 以外は処理をスキップする条件を追加
    - Bot自身のメッセージをスキップする既存処理を維持
    - チャンネルメッセージの処理コードを削除
    - _要件: 3.3_
  
  - [ ] 5.2 既存スレッドへの対応処理
    - thread_to_session() でセッション存在確認
    - セッションが存在しない場合の新規作成処理
    - Bot起動前に作成されたスレッドへの初回メッセージ対応
    - _要件: 3.3, 3.4_

- [ ] 6. セッション管理機能の拡張
  - [ ] 6.1 list_sessions メソッドの更新
    - settings.py の list_sessions() を thread_sessions 対応に修正
    - 戻り値に session_num, thread_id, type を含める
    - ソート順を session_num で統一
    - _要件: 3.5_
  
  - [ ] 6.2 コマンドライン表示の更新
    - bin/vai の list_sessions 関数を更新
    - jq を使って thread_sessions の情報を表示
    - tmux list-sessions の出力と統合
    - _要件: 3.5_

- [ ] 7. Flask アプリケーションの更新
  - [ ] 7.1 エンドポイントの調整
    - /sessions エンドポイントを thread_sessions に対応
    - チャンネル関連の処理を削除またはコメントアウト
    - _要件: 3.6_
  
  - [ ] 7.2 メッセージ転送の動作確認
    - thread_id から session_num へのマッピングが正しく機能することを確認
    - 既存の tmux 転送処理が変更なく動作することを検証
    - _要件: 3.6_

- [ ] 8. エラーハンドリングとログの実装
  - [ ] 8.1 各種エラーケースの処理追加
    - スレッド参加失敗、親メッセージ取得失敗のハンドリング
    - tmux セッション起動失敗時の適切なエラーメッセージ
    - _要件: 4.2_
  
  - [ ] 8.2 ログ出力の整備
    - 各処理ステップでの適切なログレベル設定
    - デバッグに必要な情報の記録
    - _要件: 4.3_

- [ ] 9. 統合テストの実装
  - [ ] 9.1 スレッド作成フローのテスト
    - モックを使用した on_thread_create の動作確認テスト
    - セッション作成と初期コンテクスト送信の検証
    - _要件: 3.1, 3.2, 3.4_
  
  - [ ] 9.2 メッセージ処理フローのテスト
    - スレッドメッセージの受信から転送までの統合テスト
    - 既存スレッドへの初回メッセージ処理のテスト
    - _要件: 3.3, 3.6_

- [ ] 10. 設定ファイルとドキュメントの更新
  - [ ] 10.1 設定ファイル構造の変更
    - settings.json のサンプルを新構造に更新
    - マイグレーションスクリプトの作成（既存設定がある場合）
    - _要件: 3.1, 3.4, 3.5_
  
  - [ ] 10.2 README とヘルプの更新
    - スレッドベースの新しい動作説明を追加
    - vai コマンドのヘルプテキストを更新
    - セットアップ手順の修正
    - _要件: 3.5_