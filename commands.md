# Discord Bot コマンド仕様

## !cc コマンド

### 概要
メッセージをスレッド化してClaude Codeセッションを開始するコマンド

### 使用方法
```
!cc <thread-name>
```
- 必ずスレッド化したいメッセージに返信する形で実行
- thread-name: 小文字アルファベットとハイフンのみ使用可能（例: bug-fix-login）

### 処理フロー

#### 1. バリデーション段階
1. **スレッド名チェック**
   - 指定されているか確認 → なければ「❌ スレッド名を指定してください」
   - 形式チェック（正規表現: `^[a-z]+(-[a-z]+)*$`） → 不正なら「❌ スレッド名は小文字アルファベットとハイフンのみ」
   - 長さチェック（50文字以内） → 長すぎたら「❌ スレッド名は50文字以内に」

2. **返信形式チェック**
   - `ctx.message.reference`の存在確認
   - 返信でなければ「❌ スレッド化したいメッセージに返信する形で実行」

#### 2. スレッド作成段階
3. **返信先メッセージ取得**
   - `fetch_message(ctx.message.reference.message_id)`で親メッセージを取得

4. **スレッドチェック**
   - 既にスレッド内のメッセージでないか確認
   - スレッド内なら「❌ 既にスレッド内のメッセージです」

5. **Discordスレッド作成**
   ```python
   thread = await parent_message.create_thread(
       name=thread_name
   )
   ```

6. **Bot参加**
   - `await thread.join()`でBotがスレッドに参加

#### 3. セッション設定段階
7. **セッション番号割り当て**
   - `settings.add_thread_session(thread_id)`で新規セッション番号を取得
   - settings.jsonの`thread_sessions`に保存

8. **Claude Codeセッション起動**
   - `_start_claude_session_with_context()`を呼び出し
   - 以下の処理を実行：
     1. tmuxで新規セッション作成（名前: `claude-session-{番号}`）
     2. 作業ディレクトリに移動
     3. claudeコマンド実行（設定されたオプション付き）
     4. 2秒待機
     5. 初期コンテキスト送信：
        ```
        === Discord スレッド情報 ===
        チャンネル名: {親チャンネル名}
        スレッド名: {スレッド名}
        スレッドID: {スレッドID}
        セッション番号: {番号}
        
        【重要】このセッションはDiscordのスレッド専用です。
        メッセージ送信は: dp {番号} "メッセージ"
        
        === 親メッセージ ===
        作成者: {作成者名}
        時刻: {YYYY-MM-DD HH:MM:SS}
        内容:
        {メッセージ内容}
        ===================
        ```

#### 4. 完了処理
9. **初期メッセージ投稿**
    - スレッド内に以下のメッセージを投稿：
      ```
      🧵 スレッドを作成しました！
      📝 Claude Code セッション #{番号} を開始しました。
      
      このスレッドでメッセージを送信すると、Claude Codeに転送されます。
      ```

10. **コマンドメッセージ削除**
    - 元の`!cc`コマンドメッセージを削除（権限がある場合のみ）

11. **ログ記録**
    - `Thread created via !cc command: {thread_name} (ID: {thread.id})`

### エラーハンドリング
- `discord.NotFound`: 「❌ 返信先のメッセージが見つかりません」
- `discord.Forbidden`: 「❌ スレッドを作成する権限がありません」
- その他のエラー: 「❌ エラーが発生しました: {エラーメッセージ}」

### 注意事項
- `!cc`コマンドで作成したスレッドのみがClaude Codeセッションを持つ
- 手動で作成されたスレッドではセッションは自動開始されない

## !post コマンド

### 概要
現在のスレッド名を指定チャンネルに送信するコマンド

### 使用方法
```
!post #チャンネル名
```
- スレッド内でのみ使用可能
- チャンネル名は#を付けて指定（Discord標準のメンション形式）

### 処理フロー

#### 1. バリデーション段階
1. **スレッド内実行チェック**
   - `ctx.channel.parent`の存在確認
   - スレッド外なら「❌ このコマンドはスレッド内でのみ使用可能です」

2. **チャンネル指定チェック**
   - `target_channel`パラメータの存在確認
   - 未指定なら「❌ 送信先チャンネルを指定してください。使用方法: `!post #チャンネル名`」

#### 2. 送信処理段階
3. **スレッド名取得**
   - `ctx.channel.name`で現在のスレッド名を取得

4. **メッセージ送信**
   - 送信内容: `スレッド名: {thread_name}`
   - `await target_channel.send(message_content)`で指定チャンネルに送信

#### 3. 完了処理
5. **成功メッセージ**
   - スレッド内に「✅ スレッド名を{チャンネル名}に送信しました」を表示

6. **ログ記録**
   - `Posted thread name '{thread_name}' to channel {channel_id}`

### エラーハンドリング
- `discord.Forbidden`: 「❌ 指定されたチャンネルへのアクセス権限がありません」
  - Botが指定チャンネルへの書き込み権限を持っていない場合
- その他のエラー: 「❌ エラーが発生しました: {エラーメッセージ}」

### 注意事項
- Botが送信先チャンネルへの書き込み権限を持っている必要がある
- スレッド外では使用できない（通常のチャンネルでは実行不可）
- 送信されるのはスレッド名のみで、スレッドの内容は送信されない

### 使用例
```
# スレッド「bug-fix-login」内で実行
!post #general

# 結果: #generalチャンネルに「スレッド名: bug-fix-login」が投稿される
```

## !filegen コマンド

### 概要
指定された名前でprojectsディレクトリ内にサブディレクトリを作成するコマンド

### 使用方法
```
!filegen <file-name>
```
- file-name: 小文字アルファベットとハイフンのみ使用可能（例: my-project）

### 処理フロー

#### 1. バリデーション段階
1. **ファイル名チェック**
   - 指定されているか確認 → なければ「❌ ファイル名を指定してください」
   - 形式チェック（正規表現: `^[a-z]+(-[a-z]+)*$`） → 不正なら「❌ ファイル名は小文字アルファベットとハイフンのみ」
   - 長さチェック（50文字以内） → 長すぎたら「❌ ファイル名は50文字以内に」

#### 2. ディレクトリ作成段階
2. **projectsディレクトリ確認**
   - プロジェクトルートの`projects`ディレクトリが存在しない場合は作成

3. **重複チェック**
   - `./projects/{file-name}`が既に存在する場合は「❌ ディレクトリ `{file-name}` は既に存在します」

4. **ディレクトリ作成**
   - `target_dir.mkdir(parents=True, exist_ok=True)`で作成

#### 3. 完了処理
5. **成功メッセージ**
   - 「✅ ディレクトリ `./projects/{file-name}` を作成しました」

6. **ログ記録**
   - `Created directory: {target_dir}`

### エラーハンドリング
- `PermissionError`: 「❌ ディレクトリを作成する権限がありません」
- その他のエラー: 「❌ エラーが発生しました: {エラーメッセージ}」

### 注意事項
- 作成されるディレクトリはプロジェクトルートの`./projects/`配下
- ディレクトリ名は小文字アルファベットとハイフンのみ使用可能
- 既存のディレクトリと同名の場合はエラーとなる

### 使用例
```
!filegen my-new-project

# 結果: ./projects/my-new-project/ ディレクトリが作成される
```

## !sessions コマンド

### 概要
設定されているセッションの一覧を表示するコマンド

### 使用方法
```
!sessions
```

### 処理フロー
1. **セッション一覧取得**
   - `settings.list_sessions()`で全セッション情報を取得

2. **表示処理**
   - セッションがない場合: 「No sessions configured.」
   - セッションがある場合: 
     ```
     **Configured Sessions:**
     Session 1: #channel-name
     Session 2: #another-channel
     ```

### 注意事項
- 管理者権限は不要（誰でも実行可能）
- チャンネルIDはDiscordのチャンネルメンション形式（<#ID>）で表示される