# スレッド専用セッション機能 要件定義書

## 1. 概要

Discord のスレッドごとに独立した Claude Code セッションを割り当て、スレッド内での会話コンテクストを自動的に保持する機能を実装する。登録済みチャンネル内で作成されたスレッドを自動検出し、親メッセージの内容を初期コンテキストとして含めた状態でセッションを開始する。

## 2. 背景と目的

### 現状の課題
- Discord チャンネルに直接投稿されたメッセージのみを処理している
- スレッド機能が活用されていない
- 複数の話題が混在すると、コンテクストが混乱する

### 期待される効果
- スレッドごとに独立した作業環境の提供
- 話題の分離による効率的なタスク管理
- Claude Code の自然なコンテクスト保持機能の活用

## 3. 機能要件

### 3.1 スレッド作成自動検出機能

**ユーザーストーリー：** Discord ユーザーとして、登録済みチャンネル内でスレッドを作成したとき、自動的に専用の Claude Code セッションが作成されることを期待する

**受け入れ基準：**
1. WHEN 登録済みチャンネル内でスレッドが作成される THEN システムは on_thread_create イベントを受信する
2. WHEN on_thread_create イベントが発生する THEN システムは親チャンネルIDを確認する
3. IF 親チャンネルが未登録 THEN システムはスレッドを無視する
4. IF 親チャンネルが登録済み THEN システムはスレッドに自動参加する

### 3.2 親メッセージ取得・初期コンテクスト設定機能

**ユーザーストーリー：** Discord ユーザーとして、スレッドを作成した元のメッセージが Claude Code の初期コンテクストとして含まれることを期待する

**受け入れ基準：**
1. WHEN スレッドが検出される THEN システムは thread.parent.fetch_message(thread.id) で親メッセージを取得する
2. WHEN 親メッセージが取得される THEN システムはメッセージ内容、作成者名、タイムスタンプを抽出する
3. WHEN Claude Code セッションが起動される THEN システムは親メッセージの情報を初期コンテクストとして送信する
4. IF 親メッセージの取得に失敗 THEN システムはエラーをログに記録しセッションを継続する

### 3.3 スレッドメッセージ処理機能

**ユーザーストーリー：** Discord ユーザーとして、スレッド内にメッセージを投稿したとき、自動的に専用の Claude Code セッションで処理されることを期待する

**受け入れ基準：**
1. WHEN Discord スレッドにメッセージが投稿される THEN システムは Discord.ChannelType.public_thread を検出する
2. WHEN スレッドメッセージが検出される THEN システムはスレッドIDを取得する
3. WHEN 通常のチャンネルメッセージが投稿される THEN システムは処理をスキップする
4. IF メッセージがBotユーザー自身のもの THEN システムは処理をスキップする

### 3.4 自動セッション作成機能

**ユーザーストーリー：** Discord ユーザーとして、新しいスレッドが作成されたとき、自動的に新しい Claude Code セッションが作成されることを期待する

**受け入れ基準：**
1. WHEN スレッド作成が検出される THEN システムは新しいセッション番号を割り当てる
2. WHEN 新しいセッション番号が割り当てられる THEN システムは tmux で新しい Claude Code セッションを起動する
3. WHEN セッションが正常に起動する THEN システムはスレッドIDとセッション番号のマッピングを保存する
4. IF セッション起動に失敗する THEN システムはエラーをログに記録する
5. IF スレッドに既存のセッションが存在する THEN システムは新規作成をスキップする

### 3.5 セッション管理機能

**ユーザーストーリー：** システム管理者として、どのスレッドがどのセッションに紐づいているかを確認できることを期待する

**受け入れ基準：**
1. WHEN `vai list-session` コマンドが実行される THEN システムは全スレッドセッションの一覧を表示する
2. WHEN セッション一覧が表示される THEN 各エントリにはセッション番号とスレッドIDが含まれる
3. IF スレッド名が取得可能 THEN システムはスレッド名も表示する

### 3.6 メッセージ転送機能

**ユーザーストーリー：** Discord ユーザーとして、スレッドに投稿したメッセージが正しいセッションに転送されることを期待する

**受け入れ基準：**
1. WHEN スレッドメッセージが処理される THEN システムは対応するセッション番号を取得する
2. WHEN セッション番号が特定される THEN システムはそのセッションにメッセージを転送する
3. WHEN メッセージが転送される THEN システムはローディングインジケータを表示する
4. WHEN 転送が完了する THEN システムは成功メッセージを表示する

## 4. 非機能要件

### 4.1 パフォーマンス要件
- スレッドメッセージの検出から転送までの処理時間は5秒以内
- 同時に100個のスレッドセッションをサポート可能

### 4.2 信頼性要件
- セッション起動失敗時の適切なエラーハンドリング
- 既存セッションへの再接続機能

### 4.3 保守性要件
- セッション管理ロジックの既存コードからの分離
- ログによる動作追跡の実現

### 4.4 互換性要件
- 既存の設定ファイル形式との互換性維持
- 既存のコマンド体系との統合

## 5. 制約事項

### 5.1 技術的制約
- Discord.py の制限に従う
- Discord Intents.guilds が有効である必要がある
- tmux セッション数の上限に依存
- Claude Code の同時実行数制限
- スレッドIDと親メッセージIDが同一であることに依存

### 5.2 運用上の制約
- 手動でのセッション削除が必要（自動削除機能は初期実装に含まない）
- スレッドアーカイブ時の処理は未定義
- Botはスレッドに明示的に参加する必要がある

## 6. 将来の拡張性

### 6.1 考慮すべき拡張機能
- スレッドアーカイブ時の自動セッション削除
- プライベートスレッドのサポート
- フォーラムチャンネルのサポート
- セッション状態の永続化

### 6.2 設計上の考慮
- セッション管理の抽象化による他のプラットフォーム対応
- プラガブルなセッションプロバイダー

## 7. 用語定義

| 用語 | 定義 |
|------|------|
| スレッド | Discord のチャンネル内で作成される会話の枝分かれ |
| セッション | tmux 内で実行される個別の Claude Code インスタンス |
| スレッドID | Discord が各スレッドに割り当てる一意の識別子 |
| セッション番号 | システムが各セッションに割り当てる連番 |

## 8. 依存関係

- Discord.py ライブラリ
- tmux（セッション管理）
- Claude Code CLI
- 既存の設定管理システム（settings.py）

## 9. リスクと対策

| リスク | 影響 | 対策 |
|--------|------|------|
| スレッド数の急増 | システムリソース枯渇 | セッション数上限の設定 |
| 長期未使用セッション | メモリ使用量増加 | 手動削除手順の文書化 |
| セッション起動失敗 | ユーザー体験の低下 | リトライ機構の実装検討 |